<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI 數位弦力弓 - 物理實驗介面</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #2c3e50; color: white; }
        .dashboard { margin: 20px auto; width: 80%; max-width: 600px; background: #34495e; padding: 20px; border-radius: 15px; }
        .btn { padding: 12px 25px; margin: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-connect { background: #e67e22; color: white; }
        .btn-calib { background: #27ae60; color: white; }
        #status { color: #f1c40f; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>AI 數位弦力弓：數據採集中心</h1>
    <div class="dashboard">
        <div id="status">狀態：尚未連線</div>
        <button id="btnConnect" class="btn btn-connect">連線至智慧弓 (BLE)</button>
        <br>
        <button id="btnMin" class="btn btn-calib">設為靜止狀態 (0%)</button>
        <button id="btnMax" class="btn btn-calib">設為滿弓狀態 (100%)</button>
        <h2 id="tensionDisplay">拉力值：0%</h2>
    </div>
    <div id="p5-container"></div>

    <script>
        let rawData = 0, normalizedValue = 0;
        let vMin = 1000, vMax = 3000; // 預設參考值
        let history = new Array(200).fill(0);

        // Web Bluetooth 連線邏輯
        document.getElementById('btnConnect').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0xFFE0] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xFFE0);
                const char = await service.getCharacteristic(0xFFE1);
                
                document.getElementById('status').innerText = "狀態：已連線 (" + device.name + ")";
                
                char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const decoder = new TextDecoder();
                    rawData = parseInt(decoder.decode(e.target.value));
                    
                    // 核心物理建模：數據正規化
                    normalizedValue = ((rawData - vMin) / (vMax - vMin)) * 100;
                    normalizedValue = Math.max(0, Math.min(100, normalizedValue));
                    
                    document.getElementById('tensionDisplay').innerText = "拉力值：" + Math.round(normalizedValue) + "%";
                });
            } catch (err) {
                console.error("連線失敗", err);
            }
        };

        // 校準功能：解決感測器個體差異
        document.getElementById('btnMin').onclick = () => { vMin = rawData; alert("已設定靜止基準"); };
        document.getElementById('btnMax').onclick = () => { vMax = rawData; alert("已設定滿弓基準"); };

        // p5.js 視覺化呈現
        function setup() {
            let cnv = createCanvas(600, 200);
            cnv.parent('p5-container');
        }

        function draw() {
            background(52, 73, 94);
            history.push(normalizedValue);
            history.shift();

            stroke(241, 194, 15);
            strokeWeight(3);
            noFill();
            beginShape();
            for (let i = 0; i < history.length; i++) {
                vertex(i * 3, height - (history[i] * 1.5) - 20);
            }
            endShape();
        }
    </script>
</body>
</html>
