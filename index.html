<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI æ•¸ä½å¼¦åŠ›å¼“ - æ™ºæ…§æ ¡æº–åˆ†æå„€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a2e; color: white; margin: 0; padding: 20px; }
        .dashboard { margin: 10px auto; width: 90%; max-width: 800px; background: #16213e; padding: 20px; border-radius: 15px; border: 1px solid #0f3460; }
        .btn { padding: 12px 25px; margin: 5px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-connect { background: #e94560; color: white; }
        .btn-calib { background: #0f3460; color: #e94560; border: 1px solid #e94560; }
        .data-panel { display: flex; justify-content: space-around; margin: 20px 0; background: #0f3460; padding: 15px; border-radius: 10px; }
        .value-large { font-size: 2.2em; color: #e94560; display: block; font-family: 'Courier New', monospace; }
        .label { font-size: 0.85em; color: #8892b0; text-transform: uppercase; letter-spacing: 1px; }
        #p5-container { margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <h1>ğŸ¹ å¼¦åŠ›å¼“ç‰©ç†åˆ†æç³»çµ± <small style="font-size: 0.4em; vertical-align: middle;">(Auto-Zeroing Version)</small></h1>
    
    <div class="dashboard">
        <div id="status">ç­‰å¾…è—ç‰™é€£ç·š...</div>
        <button id="btnConnect" class="btn btn-connect">é€£ç·šæ™ºæ…§å¼“ (BLE)</button>
        
        <div class="data-panel">
            <div class="data-item">
                <span class="label">ADC åŸå§‹è®€å€¼</span>
                <span id="rawDisplay" class="value-large">0000</span>
            </div>
            <div class="data-item">
                <span class="label">æ•¸ä½æ¿¾æ³¢å¾Œè®€å€¼</span>
                <span id="filterDisplay" class="value-large">0000</span>
            </div>
            <div class="data-item">
                <span class="label">æ¨™æº–åŒ–å¼µåŠ› (%)</span>
                <span id="tensionDisplay" class="value-large">0%</span>
            </div>
        </div>

        <div style="border-top: 1px solid #0f3460; padding-top: 15px;">
            <button id="btnMax" class="btn btn-calib">è¨­å®šæ»¿å¼“åƒè€ƒé»</button>
            <p class="label" style="margin-top:10px;">
                ç³»çµ±å·²å•Ÿå‹• [å‹•æ…‹æ­¸é›¶è£œå„Ÿ]ï¼šéœæ­¢é»å°‡è‡ªå‹•è¿½è¹¤æ•¸æ“šæ¼‚ç§»
            </p>
        </div>
    </div>

    <div id="p5-container"></div>

    <script>
        let rawData = 0, filteredData = 0, tension = 0;
        let vMin = 0; // éœæ­¢åŸºæº– (Auto-zeroing æœƒè‡ªå‹•æ›´æ–°æ­¤å€¼)
        let vMax = 1500; // æ»¿å¼“åŸºæº– (æ‹‰å¼“æ™‚è®Šå°ï¼Œæ•…æ­¤å€¼æ‡‰å°æ–¼ vMin)
        
        let rawHistory = new Array(10).fill(0); // æ¿¾æ³¢ç·©è¡
        let graphHistory = new Array(300).fill(0); // ç¹ªåœ–ç·©è¡
        
        let lastStableTime = Date.now();
        let isFirstData = true;

        // è—ç‰™é€£ç·šèˆ‡æ•¸æ“šæ¥æ”¶
        document.getElementById('btnConnect').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [0xFFE0] }] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xFFE0);
                const char = await service.getCharacteristic(0xFFE1);
                
                document.getElementById('status').innerText = "âœ… å·²é€£ç·šï¼š" + device.name;
                char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const decoder = new TextDecoder();
                    rawData = parseInt(decoder.decode(e.target.value));
                    processPhysicsData(rawData);
                });
            } catch (err) { document.getElementById('status').innerText = "âŒ é€£ç·šå¤±æ•—"; }
        };

        function processPhysicsData(raw) {
            // 1. ç§»å‹•å¹³å‡æ¿¾æ³¢ (Moving Average)
            rawHistory.push(raw);
            rawHistory.shift();
            filteredData = rawHistory.reduce((a, b) => a + b) / rawHistory.length;
            document.getElementById('rawDisplay').innerText = raw;
            document.getElementById('filterDisplay').innerText = Math.round(filteredData);

            if (isFirstData) { vMin = filteredData; isFirstData = false; }

            // 2. å‹•æ…‹æ­¸é›¶æ¼”ç®—æ³• (Auto-Zeroing)
            // å¦‚æœè®€å€¼æ¯”ç•¶å‰ vMin é‚„å¤§ (ä»£è¡¨æ›´é¬†) æˆ–å¾®å¹…è®Šå‹•ï¼Œç·©æ…¢æ›´æ–°åŸºæº–
            if (Math.abs(filteredData - vMin) < 20) {
                vMin = vMin * 0.95 + filteredData * 0.05; // æ¬Šé‡æ›´æ–°ï¼Œå¹³æ»‘æ¼‚ç§»
            } else if (filteredData > vMin) {
                vMin = filteredData; // å¦‚æœå‡ºç¾æ›´å¤§çš„å€¼ï¼Œç›´æ¥æ›´æ–°é›¶é»
            }

            // 3. æ¨™æº–åŒ–è¨ˆç®— (è§£æ±ºåå‘å•é¡Œ)
            // éœæ­¢(å¤§) -> vMin, æ»¿å¼“(å°) -> vMax
            tension = ((vMin - filteredData) / (vMin - vMax)) * 100;
            tension = Math.max(0, Math.min(100, tension));
            
            document.getElementById('tensionDisplay').innerText = Math.round(tension) + "%";
        }

        document.getElementById('btnMax').onclick = () => { vMax = filteredData; alert("æ»¿å¼“åŸºæº–å·²è¨­å®šï¼š" + Math.round(vMax)); };

        // p5.js ç§‘å­¸åœ–è¡¨ç¹ªè£½
        function setup() {
            let cnv = createCanvas(750, 350);
            cnv.parent('p5-container');
        }

        function draw() {
            background(26, 26, 46);
            graphHistory.push(tension);
            graphHistory.shift();

            drawAxis();

            // ç¹ªè£½æ³¢å½¢
            stroke(233, 69, 96);
            strokeWeight(3);
            noFill();
            beginShape();
            for (let i = 0; i < graphHistory.length; i++) {
                let x = 70 + (i * 2.2); 
                let y = height - 50 - (graphHistory[i] * 2.5);
                vertex(x, y);
            }
            endShape();
        }

        function drawAxis() {
            let chartLeft = 70;
            let chartBottom = height - 50;
            stroke(83, 92, 145);
            strokeWeight(1);
            
            // æ¨™ç¤ºæ ¼ç·šèˆ‡ç™¾åˆ†æ¯”
            for (let i = 0; i <= 100; i += 25) {
                let y = chartBottom - (i * 2.5);
                line(chartLeft, y, width - 30, y);
                fill(142, 148, 171);
                noStroke();
                textSize(12);
                textAlign(RIGHT, CENTER);
                text(i + "%", chartLeft - 10, y);
            }
            
            textAlign(LEFT, BOTTOM);
            text("å¼“å¼¦å¼µåŠ› (Normalized Tension)", chartLeft, 40);
        }
    </script>
</body>
</html>
